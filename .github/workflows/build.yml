name: Build and Release

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run tests
        run: go test -v -race ./...

      - name: Bump version tag
        id: tag
        run: |
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/v//' | cut -d. -f3)
          NEW="v${MAJOR}.${MINOR}.$((PATCH+1))"
          echo "tag=$NEW" >> "$GITHUB_OUTPUT"
          echo "$LATEST -> $NEW"

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (arm64)
        run: docker buildx build --platform linux/arm64 --output type=oci,dest=awg-proxy-arm64.tar -t awg-proxy:arm64 .

      - name: Build Docker image (arm/v7)
        run: docker buildx build --platform linux/arm/v7 --output type=oci,dest=awg-proxy-arm.tar -t awg-proxy:arm .

      - name: Build Docker image (amd64)
        run: docker buildx build --platform linux/amd64 --output type=oci,dest=awg-proxy-amd64.tar -t awg-proxy:amd64 .

      - name: Gzip tar files
        run: gzip awg-proxy-arm64.tar awg-proxy-arm.tar awg-proxy-amd64.tar

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: |
            awg-proxy-arm64.tar.gz
            awg-proxy-arm.tar.gz
            awg-proxy-amd64.tar.gz
